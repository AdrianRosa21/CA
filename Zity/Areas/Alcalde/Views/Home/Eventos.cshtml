@{
    ViewData["Title"] = "Eventos";
}

@section Styles {
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/eventos.css" asp-append-version="true" />
}

<div id="eventos-page" class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="fw-bold m-0">
            <span class="badge bg-gradient p-2 px-3" style="--bs-bg-opacity:.15;background:linear-gradient(135deg,#7c3aed,#0ea5e9)">
                <i class="bi bi-calendar-event me-2"></i>Eventos comunitarios
            </span>
        </h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal">
            <i class="bi bi-plus-lg me-1"></i> Nuevo evento
        </button>
    </div>

    <!-- Cards -->
    <div class="row g-3" id="evtCards"></div>

    <hr class="my-4" />

    <div class="row g-3">
        <div class="col-12 col-lg-8">
            <div id="map" class="border rounded" style="height:70vh;"></div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Cómo usar</h5>
                    <ol class="mb-3">
                        <li>Haz clic en el mapa.</li>
                        <li>Completa el modal y guarda.</li>
                    </ol>

                    <div class="d-flex gap-2 mb-3">
                        <button id="exportJson" class="btn btn-outline-secondary">⬇️ Exportar JSON</button>
                        <button id="importJsonBtn" class="btn btn-outline-secondary">⬆️ Importar JSON</button>
                        <input id="importJson" type="file" accept="application/json" hidden />
                    </div>

                    <div id="stats" class="small mb-3"></div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="tablaEventos" class="table align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Título</th>
                                            <th>Ciudad</th>
                                            <th>Municipio</th>
                                            <th>Hora</th>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- dinámico --></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- /Resumen -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nuevo evento -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <form id="evtForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input name="titulo" class="form-control" placeholder="Ej. Jornada de limpieza" required />
                </div>

                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Categoría</label>
                        <select name="categoria" class="form-select">
                            <option value="comunitario" selected>Comunitario</option>
                            <option value="deportivo">Deportivo</option>
                            <option value="cultural">Cultural</option>
                            <option value="educativo">Educativo</option>
                            <option value="salud">Salud</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo</label>
                        <!-- Reutilizamos el mismo campo que ‘nivel_urgencia’ para no tocar la lógica -->
                        <select name="nivel_urgencia" class="form-select">
                            <option value="Abierto" selected>Abierto</option>
                            <option value="Con registro">Con registro</option>
                            <option value="Privado">Privado</option>
                        </select>
                    </div>
                </div>

                <!-- Ciudad / Municipio -->
                <div class="row g-2 mt-3">
                    <div class="col-md-4">
                        <label class="form-label">Ciudad</label>
                        <input name="ciudad" class="form-control" value="San Salvador" />
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Municipio</label>
                        <input name="municipio" id="municipio" class="form-control" readonly placeholder="Se autocompleta al elegir en el mapa" />
                    </div>
                </div>

                <!-- Fecha / Hora más claros para eventos -->
                <div class="row g-2 mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Fecha del evento</label>
                        <input name="fecha_input" type="date" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hora del evento</label>
                        <input name="hora_input" type="time" class="form-control" />
                    </div>
                </div>

                <!-- Lat/Lng -->
                <div class="row g-2 mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Lat</label>
                        <input name="lat" class="form-control" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Lng</label>
                        <input name="lng" class="form-control" readonly />
                    </div>
                    <div class="form-text">La posición se llena al hacer clic en el mapa.</div>
                </div>

                <!-- Descripción / Dirección -->
                <div class="mt-3">
                    <label class="form-label">Descripción <small class="text-muted">(máx. 120)</small></label>
                    <textarea name="descripcion" class="form-control" maxlength="120" rows="3" placeholder="Ej. Limpieza del parque central y reciclaje."></textarea>
                    <div class="form-text"><span id="descCount">0/120</span></div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Dirección referencial</label>
                    <input name="direccion_referencial" class="form-control" placeholder="Ej. Parque Central de Soyapango" />
                </div>

                <!-- Imagen principal -->
                <div class="mt-3">
                    <label class="form-label">Banner / flyer</label>
                    <input type="file" accept="image/*" name="foto" id="foto" class="form-control" required>
                    <div class="form-text">Se mostrará como portada del evento.</div>
                    <img id="fotoPreview" class="img-fluid rounded mt-2 d-none" alt="Vista previa" />
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar evento</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast: fuera de zona -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1100">
    <div id="toastOutside" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"><i class="bi bi-geo-alt-fill me-2"></i> Solo se puede registrar dentro de <b>San Salvador Este</b>.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@@turf/turf@6.5.0/turf.min.js"></script>
    <script src="~/js/eventos.js" asp-append-version="true"></script>
    <script>
        window.__ZITY_UPLOAD_URL__ = '@Url.Action("UploadArchivo", "Home", new { area = "User" })';
    </script>
}
